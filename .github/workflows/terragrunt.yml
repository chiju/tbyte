name: Infrastructure Deployment

on:
  push:
    branches: [main]
    paths: ['terragrunt/**']
  pull_request:
    branches: [main]
    paths: ['terragrunt/**']
  workflow_dispatch:

env:
  AWS_REGION: eu-central-1
  TERRAGRUNT_VERSION: 0.67.16

permissions:
  id-token: write
  contents: read
  security-events: write
  pull-requests: write

jobs:
  validate:
    name: Validate & Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.13.5

      - name: Setup Terragrunt
        run: |
          wget -q https://github.com/gruntwork-io/terragrunt/releases/download/v${{ env.TERRAGRUNT_VERSION }}/terragrunt_linux_amd64
          chmod +x terragrunt_linux_amd64
          sudo mv terragrunt_linux_amd64 /usr/local/bin/terragrunt

      - name: Terraform Format Check
        working-directory: terragrunt
        run: |
          echo "üîç Checking Terraform formatting..."
          find . -name "*.tf" -exec terraform fmt -check=true -diff=true {} \;

      - name: Terraform Validate
        working-directory: terragrunt
        run: |
          echo "‚úÖ Validating Terraform configurations..."
          find . -name "*.tf" -execdir terraform init -backend=false \; -execdir terraform validate \;

      - name: Terragrunt Validate
        working-directory: terragrunt
        run: |
          echo "üîß Validating Terragrunt configurations..."
          terragrunt run-all validate --terragrunt-non-interactive --terragrunt-working-dir .

      - name: Setup Checkov
        run: |
          pip3 install checkov
          checkov --version

      - name: Run Checkov Security Scan
        working-directory: terragrunt
        run: |
          echo "üõ°Ô∏è Running security scan with Checkov..."
          checkov -d . --framework terraform \
            --output cli \
            --output sarif \
            --output-file-path console,checkov-results.sarif \
            --soft-fail

      - name: Upload Checkov Results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: terragrunt/checkov-results.sarif

      - name: TFLint Setup
        uses: terraform-linters/setup-tflint@v4
        with:
          tflint_version: latest

      - name: Run TFLint
        working-directory: terragrunt
        run: |
          echo "üîç Running TFLint..."
          find . -name "*.tf" -execdir tflint --init \; -execdir tflint \;

      - name: Terraform Docs Check
        working-directory: terragrunt
        run: |
          echo "üìö Checking if documentation is up to date..."
          # Install terraform-docs
          curl -sSLo ./terraform-docs.tar.gz https://terraform-docs.io/dl/v0.17.0/terraform-docs-v0.17.0-$(uname)-amd64.tar.gz
          tar -xzf terraform-docs.tar.gz
          chmod +x terraform-docs
          sudo mv terraform-docs /usr/local/bin/
          
          # Check if README files are up to date
          find . -name "*.tf" -execdir terraform-docs markdown table --output-file README.md . \;

  plan-shared:
    name: Plan Shared Services
    runs-on: ubuntu-latest
    needs: validate
    if: github.event_name != 'pull_request'
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.13.5

      - name: Setup Terragrunt
        run: |
          wget -q https://github.com/gruntwork-io/terragrunt/releases/download/v${{ env.TERRAGRUNT_VERSION }}/terragrunt_linux_amd64
          chmod +x terragrunt_linux_amd64
          sudo mv terragrunt_linux_amd64 /usr/local/bin/terragrunt

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Plan Shared Services
        working-directory: terragrunt
        run: |
          echo "üìã Planning Shared Services..."
          terragrunt plan --terragrunt-working-dir shared-services --terragrunt-non-interactive

  plan-dev:
    name: Plan Development
    runs-on: ubuntu-latest
    needs: validate
    if: github.event_name != 'pull_request'
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.13.5

      - name: Setup Terragrunt
        run: |
          wget -q https://github.com/gruntwork-io/terragrunt/releases/download/v${{ env.TERRAGRUNT_VERSION }}/terragrunt_linux_amd64
          chmod +x terragrunt_linux_amd64
          sudo mv terragrunt_linux_amd64 /usr/local/bin/terragrunt

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Plan Dev Environment
        working-directory: terragrunt/environments/dev
        run: |
          echo "üìã Planning Dev Environment..."
          terragrunt run-all plan --terragrunt-non-interactive

  plan-staging:
    name: Plan Staging
    runs-on: ubuntu-latest
    needs: validate
    if: github.event_name != 'pull_request'
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.13.5

      - name: Setup Terragrunt
        run: |
          wget -q https://github.com/gruntwork-io/terragrunt/releases/download/v${{ env.TERRAGRUNT_VERSION }}/terragrunt_linux_amd64
          chmod +x terragrunt_linux_amd64
          sudo mv terragrunt_linux_amd64 /usr/local/bin/terragrunt

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Plan Staging Environment
        working-directory: terragrunt/environments/staging
        run: |
          echo "üìã Planning Staging Environment..."
          terragrunt run-all plan --terragrunt-non-interactive

  plan-production:
    name: Plan Production
    runs-on: ubuntu-latest
    needs: validate
    if: github.event_name != 'pull_request'
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.13.5

      - name: Setup Terragrunt
        run: |
          wget -q https://github.com/gruntwork-io/terragrunt/releases/download/v${{ env.TERRAGRUNT_VERSION }}/terragrunt_linux_amd64
          chmod +x terragrunt_linux_amd64
          sudo mv terragrunt_linux_amd64 /usr/local/bin/terragrunt

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Plan Production Environment
        working-directory: terragrunt/environments/production
        run: |
          echo "üìã Planning Production Environment..."
          terragrunt run-all plan --terragrunt-non-interactive

  deploy-shared:
    name: Deploy Shared Services
    runs-on: ubuntu-latest
    needs: plan-shared
    environment: shared-services
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.13.5

      - name: Setup Terragrunt
        run: |
          wget -q https://github.com/gruntwork-io/terragrunt/releases/download/v${{ env.TERRAGRUNT_VERSION }}/terragrunt_linux_amd64
          chmod +x terragrunt_linux_amd64
          sudo mv terragrunt_linux_amd64 /usr/local/bin/terragrunt

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy Shared Services
        working-directory: terragrunt
        run: |
          echo "üöÄ Deploying Shared Services..."
          terragrunt apply --terragrunt-working-dir shared-services --terragrunt-non-interactive --auto-approve

  deploy-dev:
    name: Deploy Development
    runs-on: ubuntu-latest
    needs: [plan-dev, deploy-shared]
    environment: development
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.13.5

      - name: Setup Terragrunt
        run: |
          wget -q https://github.com/gruntwork-io/terragrunt/releases/download/v${{ env.TERRAGRUNT_VERSION }}/terragrunt_linux_amd64
          chmod +x terragrunt_linux_amd64
          sudo mv terragrunt_linux_amd64 /usr/local/bin/terragrunt

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy Dev Environment
        working-directory: terragrunt/environments/dev
        run: |
          echo "üöÄ Deploying Dev Environment..."
          terragrunt run-all apply --terragrunt-non-interactive --auto-approve

      - name: Smoke Tests
        run: |
          echo "üß™ Running smoke tests..."
          # Add basic connectivity tests here
          aws eks describe-cluster --name tbyte-dev --region ${{ env.AWS_REGION }} || echo "EKS cluster not ready yet"

  deploy-staging:
    name: Deploy Staging
    runs-on: ubuntu-latest
    needs: [plan-staging, deploy-dev]
    environment: staging
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.13.5

      - name: Setup Terragrunt
        run: |
          wget -q https://github.com/gruntwork-io/terragrunt/releases/download/v${{ env.TERRAGRUNT_VERSION }}/terragrunt_linux_amd64
          chmod +x terragrunt_linux_amd64
          sudo mv terragrunt_linux_amd64 /usr/local/bin/terragrunt

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy Staging Environment
        working-directory: terragrunt/environments/staging
        run: |
          echo "üöÄ Deploying Staging Environment..."
          terragrunt run-all apply --terragrunt-non-interactive --auto-approve

  deploy-production:
    name: Deploy Production
    runs-on: ubuntu-latest
    needs: [plan-production, deploy-staging]
    environment: production
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.13.5

      - name: Setup Terragrunt
        run: |
          wget -q https://github.com/gruntwork-io/terragrunt/releases/download/v${{ env.TERRAGRUNT_VERSION }}/terragrunt_linux_amd64
          chmod +x terragrunt_linux_amd64
          sudo mv terragrunt_linux_amd64 /usr/local/bin/terragrunt

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy Production Environment
        working-directory: terragrunt/environments/production
        run: |
          echo "üöÄ Deploying Production Environment..."
          terragrunt run-all apply --terragrunt-non-interactive --auto-approve

      - name: Post-Deployment Verification
        run: |
          echo "‚úÖ Production deployment completed successfully!"
          echo "üîç Running post-deployment checks..."
          aws eks describe-cluster --name tbyte-production --region ${{ env.AWS_REGION }} || echo "EKS cluster verification pending"

  notify:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    needs: [deploy-production]
    if: always()
    
    steps:
      - name: Deployment Success
        if: needs.deploy-production.result == 'success'
        run: |
          echo "üéâ All environments deployed successfully!"
          echo "‚úÖ Shared Services: ECR repositories ready"
          echo "‚úÖ Development: tbyte-dev cluster ready"  
          echo "‚úÖ Staging: tbyte-staging cluster ready"
          echo "‚úÖ Production: tbyte-production cluster ready"

      - name: Deployment Failure
        if: needs.deploy-production.result == 'failure'
        run: |
          echo "‚ùå Deployment failed. Check logs for details."
          exit 1
