name: Infrastructure Deployment

on:
  push:
    branches: [main]
    paths: ['terragrunt/**', '.github/workflows/terragrunt.yml']
  pull_request:
    branches: [main]
    paths: ['terragrunt/**', '.github/workflows/terragrunt.yml']
  workflow_dispatch:

concurrency:
  group: terragrunt-deployment
  cancel-in-progress: false

env:
  AWS_REGION: eu-central-1
  TERRAGRUNT_VERSION: 0.67.16

permissions:
  id-token: write
  contents: write
  security-events: write
  pull-requests: write

jobs:
  format-check:
    name: Format Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.13.5

      - name: Terraform Format Check
        working-directory: terragrunt
        run: |
          echo "üîç Checking Terraform formatting..."
          find . -name "*.tf" -exec terraform fmt -check=true -diff=true {} \;

  terraform-validate:
    name: Terraform Validate
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.13.5

      - name: Validate Terraform Modules
        working-directory: terragrunt
        run: |
          echo "‚úÖ Validating Terraform modules..."
          for dir in modules/*/; do
            if [ -f "$dir/main.tf" ]; then
              echo "Validating $dir"
              cd "$dir"
              terraform init -backend=false
              terraform validate
              cd - > /dev/null
            fi
          done

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Checkov
        run: |
          pip3 install checkov
          checkov --version

      - name: Run Checkov Security Scan
        working-directory: terragrunt
        run: |
          echo "üõ°Ô∏è Running security scan with Checkov..."
          checkov -d . --framework terraform \
            --output cli \
            --soft-fail

  plan-shared:
    name: Plan Shared Services
    runs-on: ubuntu-latest
    needs: [format-check, terraform-validate, security-scan]
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.13.5

      - name: Setup Terragrunt
        run: |
          wget -q https://github.com/gruntwork-io/terragrunt/releases/download/v${{ env.TERRAGRUNT_VERSION }}/terragrunt_linux_amd64
          chmod +x terragrunt_linux_amd64
          sudo mv terragrunt_linux_amd64 /usr/local/bin/terragrunt

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN_DEV }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Plan Shared Services
        working-directory: terragrunt
        run: |
          echo "üìã Planning Shared Services..."
          terragrunt plan --terragrunt-working-dir shared-services --terragrunt-non-interactive

  plan-dev:
    name: Plan Development
    runs-on: ubuntu-latest
    needs: [format-check, terraform-validate, security-scan]
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.13.5

      - name: Setup Terragrunt
        run: |
          wget -q https://github.com/gruntwork-io/terragrunt/releases/download/v${{ env.TERRAGRUNT_VERSION }}/terragrunt_linux_amd64
          chmod +x terragrunt_linux_amd64
          sudo mv terragrunt_linux_amd64 /usr/local/bin/terragrunt

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN_DEV }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Plan Dev Environment
        working-directory: terragrunt/environments/dev
        run: |
          echo "üìã Planning Dev Environment (Sequential)..."
          echo "1Ô∏è‚É£ Planning VPC..."
          cd vpc && terragrunt plan
          echo "2Ô∏è‚É£ Planning ECR..."
          cd ../ecr && terragrunt plan
          echo "3Ô∏è‚É£ Planning EKS..."
          cd ../eks && terragrunt plan
          echo "4Ô∏è‚É£ Planning RDS..."
          cd ../rds && terragrunt plan
          echo "5Ô∏è‚É£ Planning ArgoCD..."
          cd ../argocd && terragrunt plan
          echo "6Ô∏è‚É£ Planning IAM..."
          cd ../iam && terragrunt plan

  plan-staging:
    name: Plan Staging
    runs-on: ubuntu-latest
    needs: [format-check, terraform-validate, security-scan]
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.13.5

      - name: Setup Terragrunt
        run: |
          wget -q https://github.com/gruntwork-io/terragrunt/releases/download/v${{ env.TERRAGRUNT_VERSION }}/terragrunt_linux_amd64
          chmod +x terragrunt_linux_amd64
          sudo mv terragrunt_linux_amd64 /usr/local/bin/terragrunt

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN_STAGING }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Plan Staging Environment
        working-directory: terragrunt/environments/staging
        run: |
          echo "üìã Planning Staging Environment..."
          terragrunt run-all plan --terragrunt-non-interactive --terragrunt-ignore-external-dependencies

  plan-production:
    name: Plan Production
    runs-on: ubuntu-latest
    needs: [format-check, terraform-validate, security-scan]
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.13.5

      - name: Setup Terragrunt
        run: |
          wget -q https://github.com/gruntwork-io/terragrunt/releases/download/v${{ env.TERRAGRUNT_VERSION }}/terragrunt_linux_amd64
          chmod +x terragrunt_linux_amd64
          sudo mv terragrunt_linux_amd64 /usr/local/bin/terragrunt

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN_PRODUCTION }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Plan Production Environment
        working-directory: terragrunt/environments/production
        run: |
          echo "üìã Planning Production Environment..."
          terragrunt run-all plan --terragrunt-non-interactive --terragrunt-ignore-external-dependencies

  deploy-shared:
    name: Deploy Shared Services
    runs-on: ubuntu-latest
    needs: [plan-shared]
    if: false  # Disabled - using dev account setup instead
    environment: shared-services
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.13.5

      - name: Setup Terragrunt
        run: |
          wget -q https://github.com/gruntwork-io/terragrunt/releases/download/v${{ env.TERRAGRUNT_VERSION }}/terragrunt_linux_amd64
          chmod +x terragrunt_linux_amd64
          sudo mv terragrunt_linux_amd64 /usr/local/bin/terragrunt

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN_PRODUCTION }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy Shared Services
        working-directory: terragrunt
        run: |
          echo "üöÄ Deploying Shared Services..."
          terragrunt apply --terragrunt-working-dir shared-services --terragrunt-non-interactive --auto-approve

  deploy-dev:
    name: Deploy Development
    runs-on: ubuntu-latest
    needs: [plan-dev]
    if: github.ref == 'refs/heads/main'
    environment: development
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.13.5

      - name: Setup Terragrunt
        run: |
          wget -q https://github.com/gruntwork-io/terragrunt/releases/download/v${{ env.TERRAGRUNT_VERSION }}/terragrunt_linux_amd64
          chmod +x terragrunt_linux_amd64
          sudo mv terragrunt_linux_amd64 /usr/local/bin/terragrunt

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN_DEV }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy Dev Environment
        working-directory: terragrunt/environments/dev
        env:
          TF_VAR_github_app_id: ${{ secrets.ARGOCD_APP_ID }}
          TF_VAR_github_app_installation_id: ${{ secrets.ARGOCD_APP_INSTALLATION_ID }}
          TF_VAR_github_app_private_key: ${{ secrets.ARGOCD_APP_PRIVATE_KEY }}
          GITHUB_ACTIONS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN_DEV }}
        run: |
          echo "üöÄ Deploying Dev Environment (Sequential)..."
          echo "1Ô∏è‚É£ Deploying VPC..."
          cd vpc && terragrunt apply --auto-approve
          echo "2Ô∏è‚É£ Deploying ECR..."
          cd ../ecr && terragrunt apply --auto-approve
          echo "3Ô∏è‚É£ Deploying EKS..."
          cd ../eks && terragrunt apply --auto-approve
          echo "4Ô∏è‚É£ Deploying RDS..."
          cd ../rds && terragrunt apply --auto-approve
          echo "5Ô∏è‚É£ Deploying ArgoCD..."
          cd ../argocd && terragrunt apply --auto-approve
          echo "6Ô∏è‚É£ Deploying IAM..."
          cd ../iam && terragrunt apply --auto-approve

      - name: Smoke Tests
        run: |
          echo "üß™ Running smoke tests..."
          # Add basic connectivity tests here
          aws eks describe-cluster --name tbyte-dev --region ${{ env.AWS_REGION }} || echo "EKS cluster not ready yet"

  update-app-values:
    name: Update App Values
    needs: [deploy-dev]
    uses: ./.github/workflows/update-app-values.yml
    secrets: inherit

  deploy-staging:
    name: Deploy Staging
    runs-on: ubuntu-latest
    needs: [plan-staging]
    if: false  # Disabled for now - focus on dev environment
    environment: staging
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.13.5

      - name: Setup Terragrunt
        run: |
          wget -q https://github.com/gruntwork-io/terragrunt/releases/download/v${{ env.TERRAGRUNT_VERSION }}/terragrunt_linux_amd64
          chmod +x terragrunt_linux_amd64
          sudo mv terragrunt_linux_amd64 /usr/local/bin/terragrunt

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN_PRODUCTION }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy Staging Environment
        working-directory: terragrunt/environments/staging
        run: |
          echo "üöÄ Deploying Staging Environment..."
          terragrunt run-all apply --terragrunt-non-interactive --auto-approve

  deploy-production:
    name: Deploy Production
    runs-on: ubuntu-latest
    needs: [plan-production]
    if: false  # Disabled for now - focus on dev environment
    environment: production
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.13.5

      - name: Setup Terragrunt
        run: |
          wget -q https://github.com/gruntwork-io/terragrunt/releases/download/v${{ env.TERRAGRUNT_VERSION }}/terragrunt_linux_amd64
          chmod +x terragrunt_linux_amd64
          sudo mv terragrunt_linux_amd64 /usr/local/bin/terragrunt

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN_DEV }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy Production Environment
        working-directory: terragrunt/environments/production
        run: |
          echo "üöÄ Deploying Production Environment..."
          terragrunt run-all apply --terragrunt-non-interactive --auto-approve

      - name: Post-Deployment Verification
        run: |
          echo "‚úÖ Production deployment completed successfully!"
          echo "üîç Running post-deployment checks..."
          aws eks describe-cluster --name tbyte-production --region ${{ env.AWS_REGION }} || echo "EKS cluster verification pending"

  notify:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    needs: [deploy-production]
    if: always()
    
    steps:
      - name: Deployment Success
        if: needs.deploy-production.result == 'success'
        run: |
          echo "üéâ All environments deployed successfully!"
          echo "‚úÖ Shared Services: ECR repositories ready"
          echo "‚úÖ Development: tbyte-dev cluster ready"  
          echo "‚úÖ Staging: tbyte-staging cluster ready"
          echo "‚úÖ Production: tbyte-production cluster ready"

      - name: Deployment Failure
        if: needs.deploy-production.result == 'failure'
        run: |
          echo "‚ùå Deployment failed. Check logs for details."
          exit 1
