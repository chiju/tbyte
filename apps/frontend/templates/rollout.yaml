apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: frontend-rollout
  namespace: default
spec:
  replicas: 3
  strategy:
    canary:
      analysis:
        templates:
        - templateName: success-rate
        startingStep: 2   # Start analysis after 25% traffic
        args:
        - name: service-name
          value: frontend-canary
      steps:
      - setWeight: 10
      - pause: {duration: 30s}
      - setWeight: 25
      - pause: {duration: 60s}    # Analysis runs here
      - setWeight: 50
      - pause: {duration: 60s}
      - setWeight: 75
      - pause: {duration: 30s}
      canaryService: frontend-canary
      stableService: frontend-stable
      trafficRouting:
        istio:
          virtualServices:
          - name: common-routes
            namespace: istio-system
            routes:
            - match:
              - uri:
                  prefix: /
                headers:
                  host:
                    exact: tbyte.local
          destinationRule:
            name: frontend-dr
            canarySubsetName: canary
            stableSubsetName: stable
      # Automatic rollback configuration
      abortScaleDownDelaySeconds: 30
      scaleDownDelaySeconds: 30
      progressDeadlineSeconds: 600
  selector:
    matchLabels:
      app: frontend
  template:
    metadata:
      labels:
        app: frontend
    spec:
      containers:
      - name: frontend
        image: {{ .Values.image.repository }}:{{ .Values.image.tag }}
        ports:
        - containerPort: 80
        resources:
          requests:
            memory: "64Mi"
            cpu: "50m"
          limits:
            memory: "128Mi"
            cpu: "100m"
        readinessProbe:
          httpGet:
            path: /
            port: 80
          initialDelaySeconds: 5
          periodSeconds: 10
        livenessProbe:
          httpGet:
            path: /
            port: 80
          initialDelaySeconds: 15
          periodSeconds: 20
